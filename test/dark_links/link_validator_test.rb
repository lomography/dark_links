require 'test_helper'

module DarkLinks
  class LinkValidatorTest < Minitest::Test
    def test_links_hash_should_reflect_link_status
      stub_request(:any, "http://www.lomography.com/").to_return(status: 200)
      stub_request(:any, "http://www.lomographybrrzl.com/").to_timeout


      links = Text.new.check_links("visit us at http://www.lomography.com ")
      assert_equal [true], links.values

      links = Text.new.check_links("this text does not contain any links")
      assert_equal [], links.values

      links = Text.new.check_links("brzl brzl: http://www.lomographybrrzl.com")
      assert_equal [false], links.values
    end

    def test_links_with_errors
      stub_request(:any, "http://www.lomography.com/").to_return(status: 200)
      stub_request(:any, "http://www.lomography.com/brzlbrzl").to_return(status: 404)
      stub_request(:any, "http://www.lomographybrrzl.com/").to_timeout

      links = Text.new.check_links("wrong: http://www.lomographybrrzl.com, 404: http://www.lomography.com/brzlbrzl, ok: http://www.lomography.com/ ")
      assert_equal false, links["http://www.lomographybrrzl.com"]
      assert_equal false, links["http://www.lomography.com/brzlbrzl"]
      assert_equal true,  links["http://www.lomography.com/"]
    end

    def test_link_with_internal_server_error
      stub_request(:any, "http://www.lomography.com/server_error").to_return(status: 500)

      links = Text.new.check_links("server error: http://www.lomography.com/server_error")
      assert_equal false, links["http://www.lomography.com/server_error"]
    end

    def test_escaped_link
      stub_request(:any, "http://www.nasa.gov/hello?id=42&key=23").to_return(status: 200)
      links = Text.new.check_links("Here is something that you might find in html: <a href=\"http://www.nasa.gov/hello?id=42&amp;key=23\">nasa</a>")
      assert_equal true, links["http://www.nasa.gov/hello?id=42&key=23"]
    end

    def test_https_link
      stub_request(:any, "https://www.nasa.gov/").to_return(status: 200)
      links = Text.new.check_links("Here is something that you might find in html: <a href=\"https://www.nasa.gov/\">nasa</a>")
      assert_equal true, links["https://www.nasa.gov/"]
    end

    def test_server_that_only_allows_get
      stub_request(:head, "http://www.lomography.com/").to_return(status: 405)
      stub_request(:get, "http://www.lomography.com/").to_return(status: 200)

      links = Text.new.check_links("ok: http://www.lomography.com/ ")
      assert_equal true,  links["http://www.lomography.com/"]
    end


    def test_with_same_link_with_different_unicode_spaces
      stub_request(:any, "http://www.lomography.com/").to_return(status: 200)

      links = Text.new.check_links("link like this: \"http://www.lomography.com\u00A0\" is the same as link like this: \"http://www.lomography.com \"")

      assert_equal true, links["http://www.lomography.com"]
      assert_equal 1, links.count
    end

    def test_link_with_connection_refused_error
      stub_request(:head, "http://shop.lomography.jp/").to_raise(Errno::ECONNREFUSED)

      links = Text.new.check_links("server error: http://shop.lomography.jp/")

      assert_equal false, links["http://shop.lomography.jp/"]
    end

    def test_link_ending_with_hyphen
      stub_request(:head, "http://www.lomography.com/homes/-a-l-b-e-r-t-o-").to_return(status: 200)

      links = Text.new.check_links("Link: http://www.lomography.com/homes/-a-l-b-e-r-t-o-")

      assert_equal true, links["http://www.lomography.com/homes/-a-l-b-e-r-t-o-"]
    end

    def test_ssl_error
      stub_request(:head, "https://www.instagram.cn/ekrogh/").to_raise(OpenSSL::SSL::SSLError)

      links = Text.new.check_links("Link: https://www.instagram.cn/ekrogh/")

      assert_equal false, links["https://www.instagram.cn/ekrogh/"]
    end

    def test_not_handled_exception
      stub_request(:head, "https://www.instagram.cn/ekrogh/").to_raise(Exception)

      links = Text.new.check_links("Link: https://www.instagram.cn/ekrogh/")

      assert_equal false, links["https://www.instagram.cn/ekrogh/"]
    end

    def test_using_different_user_agent
      stub_request(:head, "https://twitter.com/lomography").to_return(status: 400)
      stub_request(:get, "https://twitter.com/lomography").with(headers: {
        "User-Agent" => "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.141 Safari/537.36"
      }).to_return(status: 200)

      links = Text.new.check_links("https://twitter.com/lomography")

      assert_equal true, links["https://twitter.com/lomography"]
    end

    def test_links_not_allowing_head_requests
      stub_request(:head, "https://instagram.com/lomography").to_return(status: 400)
      stub_request(:get, "https://instagram.com/lomography").to_return(status: 200)

      links = Text.new.check_links("https://instagram.com/lomography")

      assert_equal true, links["https://instagram.com/lomography"]
    end

    def test_real_world_test
      urls = [
        "http://www.w3.org/1999/xhtml",
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd",
        "https://www.facebook.com/lomographyitalia/",
        "http://www.thelomographer.com/static/facebook.black.png",
        "https://www.instagram.com/lomographyitalia/",
        "http://www.thelomographer.com/static/instagram.black.png",
        "https://www.twitter.com/lomography",
        "http://www.thelomographer.com/static/twitter.black.png",
        "http://www.thelomographer.com/2017/nl_local_events_it/it",
        "http://www.lomography.it/magazine/332819-la-bellezza-ritrovata-a-shot-per-hope",
        "http://www.thelomographer.com/2017/nl_local_events_it/images/header-top.jpg",
        "http://www.thelomographer.com/2017/nl_local_events_it/images/header.it.gif",
        "http://www.thelomographer.com/2017/nl_local_events_it/images/spacer.gif",
        "http://www.thelomographer.com/2017/nl_local_events_it/images/section1-3.jpg",
        "http://www.thelomographer.com/2017/nl_local_events_it/images/section1-2.jpg",
        "https://www.facebook.com/events/120325625357735",
        "http://www.thelomographer.com/2017/nl_local_events_it/images/section2.jpg",
        "http://www.humansofnaples.it/",
        "https://shop.lomography.com/it/cameras/lomo-instant-wide",
        "https://www.maratonafotograficabrescia.it/maratona-fotografica/brescia-speciale-tappa-istantanea-collaborazione-lomography/",
        "http://www.thelomographer.com/2017/nl_local_events_it/images/section3.jpg",
        "https://shop.lomography.com/it/lomo-instant-camera-murano",
        "http://www.thelomographer.com/2017/nl_redesign_events/images/space.gif",
        "https://microsites.lomography.com/25-years-of-lomography/get-involved/",
        "http://www.thelomographer.com/static/footer_25years.gif",
        "http://shop.lomography.com/it",
        "https://www.lomography.it/about/stores",
        "https://www.lomography.it/",
        "https://www.lomography.it/magazine",
        "http://www.thelomographer.com/static/lomography.png"
      ]

      urls.each do |url|
        stub_request(:any, url).to_return(status: 200)
      end

      text = "\r\n<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\r\n<html xmlns=\"http://www.w3.org/1999/xhtml\">\r\n  <head>\r\n    <meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\" />\r\n    <meta name=\"viewport\" content=\"width=device-width,maximum-scale=1.0,initial-scale=1.0,minimum-scale=1.0\">\r\n    <title>Eventi di fotografia istantanea in tutta Italia</title>\r\n    <style type=\"text/css\">\r\n      body { padding: 0; margin: 0; color: #4f5661; }\r\n      img { outline: none; text-decoration: none; -ms-interpolation-mode: bicubic; }\r\n      a img { border: none; }\r\n      a { color: #4f5661; text-decoration: underline; }\r\n      a:hover { color: #4f5661; }\r\n      .ExternalClass * { line-height: 79%; }\r\n      .c-ReadMessagePartBody .ExternalClass a:link { text-decoration: none; }\r\n      @media only screen and (min-width: 600px) {\r\n        table.large { width: 100%; max-width: 700px; }\r\n        table.large img.responsive { width: 100%; height: auto; }\r\n      }\r\n      @media only screen and (max-width: 600px) {\r\n        img.spacer { width: 100%; }\r\n        img.responsive { width: 100%; height: auto; }\r\n        table { width: 100% !important; }\r\n        td.responsive { display: block !important; width: auto !important; }\r\n      }\r\n    </style>\r\n    <!--[if gte mso 9]> <style> li { text-indent: -1em; } </style> <![endif]-->\r\n  </head>\r\n  <body bgcolor=\"#ffffff\" style=\"background-color: #ffffff; -webkit-text-size-adjust: none;\">\r\n    <span class=\"preheader\" style=\"display: none; color: #ffffff;\"><font style=\"font-family: -apple-system, BlinkMacSystemFont, '.SFNSText-Regular', 'San Francisco', 'Roboto', 'Segoe UI', 'Helvetica Neue', 'Lucida Grande', sans-serif; font-size: 13px; line-height: 26px; color: #ffffff;\">Siamo felici oggi di presentare alcuni eventi di fotografia istantanea che si svolgeranno presto in alcune citt√† italiane: da segnare...</font></span>\r\n    <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" bgcolor=\"#ffffff\" style=\"background-color: #ffffff;\">\r\n      <tr>\r\n        <td align=\"center\" bgcolor=\"#ffffff\" style=\"background-color: #ffffff;\">\r\n                      <table border=\"0\" cellpadding=\"0\" cellspacing=\"20\" width=\"600\" bgcolor=\"#ffffff\" style=\"background-color: #ffffff;\">\r\n  <tr>\r\n    <td valign=\"middle\" align=\"left\">\r\n      <a href=\"https://www.facebook.com/lomographyitalia/\"><img width=\"24\" height=\"24\" alt=\"Facebook\" src=\"http://www.thelomographer.com/static/facebook.black.png\" /></a>\r\n      <a href=\"https://www.instagram.com/lomographyitalia/\"><img width=\"24\" height=\"24\" alt=\"Instagram\" src=\"http://www.thelomographer.com/static/instagram.black.png\" /></a>\r\n      <a href=\"https://www.twitter.com/lomography\"><img width=\"24\" height=\"24\" alt=\"Twitter\" src=\"http://www.thelomographer.com/static/twitter.black.png\" /></a>\r\n    </td>\r\n          <td valign=\"middle\" align=\"right\">\r\n        <font style=\"font-family: -apple-system, BlinkMacSystemFont, '.SFNSText-Regular', 'San Francisco', 'Roboto', 'Segoe UI', 'Helvetica Neue', 'Lucida Grande', sans-serif; font-size: 13px; line-height: 26px; color: #4f5661;\"><a style=\"color: #4f5661; text-decoration: underline;\" href=\"http://www.thelomographer.com/2017/nl_local_events_it/it\">Visualizza nel browser</a></font>      </td>\r\n      </tr>\r\n</table>\r\n                    \r\n      <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"600\" bgcolor=\"#ffffff\" style=\"line-height: 0px; background-color: #ffffff;\" class=\"large\">\r\n        <tr>\r\n          <td class=\"responsive\" bgcolor=\"#ffffff\" style=\"background-color: #ffffff;\"><a href=\"http://www.lomography.it/magazine/332819-la-bellezza-ritrovata-a-shot-per-hope\"><img width=\"600\" class=\"responsive\" alt=\"photo\" src=\"http://www.thelomographer.com/2017/nl_local_events_it/images/header-top.jpg\" /></a></td>\r\n        </tr>\r\n      </table>\r\n    \r\n      <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"600\" bgcolor=\"#ffffff\" style=\"line-height: 0px; background-color: #ffffff;\" class=\"large\">\r\n        <tr>\r\n          <td class=\"responsive\" bgcolor=\"#ffffff\" style=\"background-color: #ffffff;\"><a href=\"http://www.lomography.it/magazine/332819-la-bellezza-ritrovata-a-shot-per-hope\"><img width=\"600\" class=\"responsive\" alt=\"photo\" src=\"http://www.thelomographer.com/2017/nl_local_events_it/images/header.it.gif\" /></a></td>\r\n        </tr>\r\n      </table>\r\n    \r\n\r\n      <table border=\"0\" cellpadding=\"0\" cellspacing=\"10\" width=\"600\" bgcolor=\"#ffffff\" style=\"background-color: #ffffff;\">\r\n        <tr>\r\n          <td class=\"responsive\" valign=\"top\" bgcolor=\"#ffffff\" style=\"background-color: #ffffff;\">\r\n            <table border=\"0\" cellpadding=\"10\" cellspacing=\"0\" width=\"580\">\r\n              <tr>\r\n                <td class=\"responsive\" valign=\"top\" align=\"left\"><font style=\"font-family: -apple-system, BlinkMacSystemFont, '.SFNSText-Regular', 'San Francisco', 'Roboto', 'Segoe UI', 'Helvetica Neue', 'Lucida Grande', sans-serif; font-size: 16px; line-height: 30px; color: #4f5661;\">Siamo felici oggi di presentare alcuni eventi di fotografia istantanea che si svolgeranno presto in alcune citt√† italiane: da segnare in agenda e da non farseli perdere se siete in zona.</font></td>\r\n              </tr>\r\n            </table>\r\n          </td>\r\n        </tr>\r\n      </table>\r\n    \r\n\r\n\r\n\r\n      <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"600\" bgcolor=\"#ffffff\" style=\"line-height: 0px; background-color: #ffffff;\">\r\n        <tr>\r\n          <td class=\"responsive\">\r\n            <img width=\"600\" height=\"40\" class=\"spacer\" alt=\" \" src=\"http://www.thelomographer.com/2017/nl_local_events_it/images/spacer.gif\" />\r\n          </td>\r\n        </tr>\r\n      </table>\r\n    \r\n      <table border=\"0\" cellpadding=\"0\" cellspacing=\"10\" width=\"600\" bgcolor=\"#ffffff\" style=\"background-color: #ffffff;\">\r\n        <tr>\r\n          <td class=\"responsive\" valign=\"top\" bgcolor=\"#ffffff\" style=\"background-color: #ffffff;\">\r\n            <table border=\"0\" cellpadding=\"10\" cellspacing=\"0\" width=\"580\">\r\n              <tr>\r\n                <td class=\"responsive\" valign=\"top\" align=\"center\"><font style=\"font-family: -apple-system, BlinkMacSystemFont, '.SFNSText-Regular', 'San Francisco', 'Roboto', 'Segoe UI', 'Helvetica Neue', 'Lucida Grande', sans-serif; font-size: 36px; line-height: 40px; color: #4f5661 !important; color: #4f5661;\">La bellezza ritrovata: Mostra Fotografica di Charley Fazio e i bambini siriani</font></td>\r\n              </tr>\r\n            </table>\r\n          </td>\r\n        </tr>\r\n      </table>\r\n    \r\n      <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"600\" bgcolor=\"#ffffff\" style=\"line-height: 0px; background-color: #ffffff;\" class=\"\">\r\n        <tr>\r\n          <td class=\"responsive\" bgcolor=\"#ffffff\" style=\"background-color: #ffffff;\"><a href=\"http://www.lomography.it/magazine/332819-la-bellezza-ritrovata-a-shot-per-hope\"><img width=\"600\" class=\"responsive\" alt=\"photo\" src=\"http://www.thelomographer.com/2017/nl_local_events_it/images/section1-3.jpg\" /></a></td>\r\n        </tr>\r\n      </table>\r\n    \r\n      <table border=\"0\" cellpadding=\"0\" cellspacing=\"10\" width=\"600\" bgcolor=\"#ffffff\" style=\"background-color: #ffffff;\">\r\n        <tr>\r\n          <td class=\"responsive\" valign=\"top\" bgcolor=\"#ffffff\" style=\"background-color: #ffffff;\">\r\n            <table border=\"0\" cellpadding=\"10\" cellspacing=\"0\" width=\"580\">\r\n              <tr>\r\n                <td class=\"responsive\" valign=\"top\" align=\"left\"><font style=\"font-family: -apple-system, BlinkMacSystemFont, '.SFNSText-Regular', 'San Francisco', 'Roboto', 'Segoe UI', 'Helvetica Neue', 'Lucida Grande', sans-serif; font-size: 16px; line-height: 30px; color: #4f5661;\">Charley Fazio √® un fotografo specializzato in progetti umanitari. Di recente si √® recato a Killis, citt√† presso il confine turco-siriano, dove √® rimasto colpito dalla speranza e innocenza presente negli occhi dei bambini rifugiati. <br><br>Charley non si √® limitato ad immortalare le vite dei ragazzi, ma li ha coinvolti in prima persona in un progetto fotografico. Ha infatti consegnato loro una Lomo'Instant Wide, chiedendogli di trasmettere attraverso le immagini la loro idea di bellezza: un'occasione unica per sentirsi speciali e per dare forma ai propri pensieri.</font></td>\r\n              </tr>\r\n            </table>\r\n          </td>\r\n        </tr>\r\n      </table>\r\n    \r\n      <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"600\" bgcolor=\"#ffffff\" style=\"line-height: 0px; background-color: #ffffff;\" class=\"\">\r\n        <tr>\r\n          <td class=\"responsive\" bgcolor=\"#ffffff\" style=\"background-color: #ffffff;\"><a href=\"http://www.lomography.it/magazine/332819-la-bellezza-ritrovata-a-shot-per-hope\"><img width=\"600\" class=\"responsive\" alt=\"photo\" src=\"http://www.thelomographer.com/2017/nl_local_events_it/images/section1-2.jpg\" /></a></td>\r\n        </tr>\r\n      </table>\r\n    \r\n      <table border=\"0\" cellpadding=\"0\" cellspacing=\"10\" width=\"600\" bgcolor=\"#ffffff\" style=\"background-color: #ffffff;\">\r\n        <tr>\r\n          <td class=\"responsive\" valign=\"top\" bgcolor=\"#ffffff\" style=\"background-color: #ffffff;\">\r\n            <table border=\"0\" cellpadding=\"10\" cellspacing=\"0\" width=\"580\">\r\n              <tr>\r\n                <td class=\"responsive\" valign=\"top\" align=\"left\"><font style=\"font-family: -apple-system, BlinkMacSystemFont, '.SFNSText-Regular', 'San Francisco', 'Roboto', 'Segoe UI', 'Helvetica Neue', 'Lucida Grande', sans-serif; font-size: 16px; line-height: 30px; color: #4f5661;\">La prima data sar√† ospitata presso le sale nobiliari del Castello Visconteo di Voghera (PV) dal 1 al 15 ottobre 2017, per poi toccare, in forma itinerante, diverse citt√† italiane ed europee, anche con lo scopo di promuovere i progetti delle Onlus a sostegno degli stessi bambini siriani, ai quali sono destinati i ricavi delle vendite delle istantanee.</font></td>\r\n              </tr>\r\n            </table>\r\n          </td>\r\n        </tr>\r\n      </table>\r\n    \r\n      <table border=\"0\" cellpadding=\"0\" cellspacing=\"10\" width=\"600\" bgcolor=\"#ffffff\" style=\"background-color: #ffffff;\">\r\n        <tr>\r\n          <td class=\"responsive\" valign=\"top\" bgcolor=\"#ffffff\" style=\"background-color: #ffffff;\">\r\n            <table border=\"0\" cellpadding=\"10\" cellspacing=\"0\" width=\"580\">\r\n              <tr>\r\n                <td class=\"responsive\" valign=\"top\" align=\"center\">\r\n    <div>\r\n      <!--[if mso]>\r\n      <v:rect xmlns:v=\"urn:schemas-microsoft-com:vml\" xmlns:w=\"urn:schemas-microsoft-com:office:word\" href=\"http://www.lomography.it/magazine/332819-la-bellezza-ritrovata-a-shot-per-hope\" style=\"width: 270px;\" strokewidth=\"1px\" strokecolor=\"#7c9bd3\" fillcolor=\"#7c9bd3\">\r\n        <v:textbox style=\"mso-fit-shape-to-text:t\" inset=\"14px,7px,14px,7px\">\r\n          <center style=\"color: #ffffff; font-family: -apple-system, BlinkMacSystemFont, '.SFNSText-Regular', 'San Francisco', 'Roboto', 'Segoe UI', 'Helvetica Neue', 'Lucida Grande', sans-serif; font-size: 14px; line-height: 20px; font-weight: normal;\">LEGGI DI PI√ô</center>\r\n        </v:textbox>\r\n      </v:rect>\r\n      <![endif]-->\r\n      <a href=\"http://www.lomography.it/magazine/332819-la-bellezza-ritrovata-a-shot-per-hope\" style=\"background-color: #7c9bd3; border: 1px solid #7c9bd3; border-radius: 14px; color: #ffffff; display: inline-block; font-family: -apple-system, BlinkMacSystemFont, '.SFNSText-Regular', 'San Francisco', 'Roboto', 'Segoe UI', 'Helvetica Neue', 'Lucida Grande', sans-serif; font-size: 14px; line-height: 20px; font-weight: normal; text-align: center; text-decoration: none; width: 320px; padding: 14px 0;\"><span style=\"display: inline-block; padding: 0 14px;\">LEGGI DI PI√ô</span></a>\r\n    </div>\r\n    </td>\r\n              </tr>\r\n            </table>\r\n          </td>\r\n        </tr>\r\n      </table>\r\n    \r\n\r\n\r\n      <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"600\" bgcolor=\"#ffffff\" style=\"line-height: 0px; background-color: #ffffff;\">\r\n        <tr>\r\n          <td class=\"responsive\">\r\n            <img width=\"600\" height=\"40\" class=\"spacer\" alt=\" \" src=\"http://www.thelomographer.com/2017/nl_local_events_it/images/spacer.gif\" />\r\n          </td>\r\n        </tr>\r\n      </table>\r\n    \r\n      <table border=\"0\" cellpadding=\"0\" cellspacing=\"10\" width=\"600\" bgcolor=\"#ffffff\" style=\"background-color: #ffffff;\">\r\n        <tr>\r\n          <td class=\"responsive\" valign=\"top\" bgcolor=\"#ffffff\" style=\"background-color: #ffffff;\">\r\n            <table border=\"0\" cellpadding=\"10\" cellspacing=\"0\" width=\"580\">\r\n              <tr>\r\n                <td class=\"responsive\" valign=\"top\" align=\"left\"><font style=\"font-family: -apple-system, BlinkMacSystemFont, '.SFNSText-Regular', 'San Francisco', 'Roboto', 'Segoe UI', 'Helvetica Neue', 'Lucida Grande', sans-serif; font-size: 36px; line-height: 40px; color: #4f5661 !important; color: #4f5661;\">Instant - Humans of Naples x Lomography</font></td>\r\n              </tr>\r\n            </table>\r\n          </td>\r\n        </tr>\r\n      </table>\r\n    \r\n      <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"600\" bgcolor=\"#ffffff\" style=\"line-height: 0px; background-color: #ffffff;\" class=\"\">\r\n        <tr>\r\n          <td class=\"responsive\" bgcolor=\"#ffffff\" style=\"background-color: #ffffff;\"><a href=\"https://www.facebook.com/events/120325625357735\"><img width=\"600\" class=\"responsive\" alt=\"photo\" src=\"http://www.thelomographer.com/2017/nl_local_events_it/images/section2.jpg\" /></a></td>\r\n        </tr>\r\n      </table>\r\n    \r\n      <table border=\"0\" cellpadding=\"0\" cellspacing=\"10\" width=\"600\" bgcolor=\"#ffffff\" style=\"background-color: #ffffff;\">\r\n        <tr>\r\n          <td class=\"responsive\" valign=\"top\" bgcolor=\"#ffffff\" style=\"background-color: #ffffff;\">\r\n            <table border=\"0\" cellpadding=\"10\" cellspacing=\"0\" width=\"580\">\r\n              <tr>\r\n                <td class=\"responsive\" valign=\"top\" align=\"left\"><font style=\"font-family: -apple-system, BlinkMacSystemFont, '.SFNSText-Regular', 'San Francisco', 'Roboto', 'Segoe UI', 'Helvetica Neue', 'Lucida Grande', sans-serif; font-size: 16px; line-height: 30px; color: #4f5661;\"><a style=\"color: #4f5661; text-decoration: underline;\" href=\"http://www.humansofnaples.it/\">Humans of Naples</a> √® un progetto fotografico di Vincenzo Noletto, con il quale vuole raccontare le storie degli abitanti della citt√† partenopea. <br><br>Il 22 settembre, dalle ore 19, Domenico e Vincenzo organizzano Instant, mostra fotografica vuota, in cui tutti i visitatori diventano soggetti fotografati e protagonisti della mostra stessa. Le foto saranno scattate con la <a style=\"color: #4f5661; text-decoration: underline;\" href=\"https://shop.lomography.com/it/cameras/lomo-instant-wide\">Lomo‚ÄôInstant Wide</a> e faranno parte della nuova sezione di \"Humans of Naples\". <br><br>Vi aspettano il 22 settembre allo Slash art/msic (via Vincenzo Bellini, 45; Napoli) dalle 19:00.</font></td>\r\n              </tr>\r\n            </table>\r\n          </td>\r\n        </tr>\r\n      </table>\r\n    \r\n      <table border=\"0\" cellpadding=\"0\" cellspacing=\"10\" width=\"600\" bgcolor=\"#ffffff\" style=\"background-color: #ffffff;\">\r\n        <tr>\r\n          <td class=\"responsive\" valign=\"top\" bgcolor=\"#ffffff\" style=\"background-color: #ffffff;\">\r\n            <table border=\"0\" cellpadding=\"10\" cellspacing=\"0\" width=\"580\">\r\n              <tr>\r\n                <td class=\"responsive\" valign=\"top\" align=\"center\">\r\n    <div>\r\n      <!--[if mso]>\r\n      <v:rect xmlns:v=\"urn:schemas-microsoft-com:vml\" xmlns:w=\"urn:schemas-microsoft-com:office:word\" href=\"https://www.facebook.com/events/120325625357735\" style=\"width: 270px;\" strokewidth=\"1px\" strokecolor=\"#7c9bd3\" fillcolor=\"#7c9bd3\">\r\n        <v:textbox style=\"mso-fit-shape-to-text:t\" inset=\"14px,7px,14px,7px\">\r\n          <center style=\"color: #ffffff; font-family: -apple-system, BlinkMacSystemFont, '.SFNSText-Regular', 'San Francisco', 'Roboto', 'Segoe UI', 'Helvetica Neue', 'Lucida Grande', sans-serif; font-size: 14px; line-height: 20px; font-weight: normal;\">EVENTO FB</center>\r\n        </v:textbox>\r\n      </v:rect>\r\n      <![endif]-->\r\n      <a href=\"https://www.facebook.com/events/120325625357735\" style=\"background-color: #7c9bd3; border: 1px solid #7c9bd3; border-radius: 14px; color: #ffffff; display: inline-block; font-family: -apple-system, BlinkMacSystemFont, '.SFNSText-Regular', 'San Francisco', 'Roboto', 'Segoe UI', 'Helvetica Neue', 'Lucida Grande', sans-serif; font-size: 14px; line-height: 20px; font-weight: normal; text-align: center; text-decoration: none; width: 320px; padding: 14px 0;\"><span style=\"display: inline-block; padding: 0 14px;\">EVENTO FB</span></a>\r\n    </div>\r\n    </td>\r\n              </tr>\r\n            </table>\r\n          </td>\r\n        </tr>\r\n      </table>\r\n    \r\n\r\n\r\n      <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"600\" bgcolor=\"#ffffff\" style=\"line-height: 0px; background-color: #ffffff;\">\r\n        <tr>\r\n          <td class=\"responsive\">\r\n            <img width=\"600\" height=\"40\" class=\"spacer\" alt=\" \" src=\"http://www.thelomographer.com/2017/nl_local_events_it/images/spacer.gif\" />\r\n          </td>\r\n        </tr>\r\n      </table>\r\n    \r\n      <table border=\"0\" cellpadding=\"0\" cellspacing=\"10\" width=\"600\" bgcolor=\"#ffffff\" style=\"background-color: #ffffff;\">\r\n        <tr>\r\n          <td class=\"responsive\" valign=\"top\" bgcolor=\"#ffffff\" style=\"background-color: #ffffff;\">\r\n            <table border=\"0\" cellpadding=\"10\" cellspacing=\"0\" width=\"580\">\r\n              <tr>\r\n                <td class=\"responsive\" valign=\"top\" align=\"left\"><font style=\"font-family: -apple-system, BlinkMacSystemFont, '.SFNSText-Regular', 'San Francisco', 'Roboto', 'Segoe UI', 'Helvetica Neue', 'Lucida Grande', sans-serif; font-size: 36px; line-height: 40px; color: #4f5661 !important; color: #4f5661;\">Maratona Fotografica di Brescia ‚Äì Speciale Tappa Istantanea</font></td>\r\n              </tr>\r\n            </table>\r\n          </td>\r\n        </tr>\r\n      </table>\r\n    \r\n      <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"600\" bgcolor=\"#ffffff\" style=\"line-height: 0px; background-color: #ffffff;\" class=\"\">\r\n        <tr>\r\n          <td class=\"responsive\" bgcolor=\"#ffffff\" style=\"background-color: #ffffff;\"><a href=\"https://www.maratonafotograficabrescia.it/maratona-fotografica/brescia-speciale-tappa-istantanea-collaborazione-lomography/\"><img width=\"600\" class=\"responsive\" alt=\"photo\" src=\"http://www.thelomographer.com/2017/nl_local_events_it/images/section3.jpg\" /></a></td>\r\n        </tr>\r\n      </table>\r\n    \r\n      <table border=\"0\" cellpadding=\"0\" cellspacing=\"10\" width=\"600\" bgcolor=\"#ffffff\" style=\"background-color: #ffffff;\">\r\n        <tr>\r\n          <td class=\"responsive\" valign=\"top\" bgcolor=\"#ffffff\" style=\"background-color: #ffffff;\">\r\n            <table border=\"0\" cellpadding=\"10\" cellspacing=\"0\" width=\"580\">\r\n              <tr>\r\n                <td class=\"responsive\" valign=\"top\" align=\"left\"><font style=\"font-family: -apple-system, BlinkMacSystemFont, '.SFNSText-Regular', 'San Francisco', 'Roboto', 'Segoe UI', 'Helvetica Neue', 'Lucida Grande', sans-serif; font-size: 16px; line-height: 30px; color: #4f5661;\">Il 17 settembre, durante la Maratona Fotografica di Brescia, c‚Äô√® la possibilit√† di provare una Lomo‚ÄôInstant, compilando <a style=\"color: #4f5661; text-decoration: underline;\" href=\"https://www.maratonafotograficabrescia.it/maratona-fotografica/brescia-speciale-tappa-istantanea-collaborazione-lomography/\">questo form</a>. Al termine della Maratona Fotografica, verr√† scelta la migliore istantanea e premiata con la nuova <a style=\"color: #4f5661; text-decoration: underline;\" href=\"https://shop.lomography.com/it/lomo-instant-camera-murano\">Lomo‚ÄôInstant Murano</a>.</font></td>\r\n              </tr>\r\n            </table>\r\n          </td>\r\n        </tr>\r\n      </table>\r\n    \r\n      <table border=\"0\" cellpadding=\"0\" cellspacing=\"10\" width=\"600\" bgcolor=\"#ffffff\" style=\"background-color: #ffffff;\">\r\n        <tr>\r\n          <td class=\"responsive\" valign=\"top\" bgcolor=\"#ffffff\" style=\"background-color: #ffffff;\">\r\n            <table border=\"0\" cellpadding=\"10\" cellspacing=\"0\" width=\"580\">\r\n              <tr>\r\n                <td class=\"responsive\" valign=\"top\" align=\"center\">\r\n    <div>\r\n      <!--[if mso]>\r\n      <v:rect xmlns:v=\"urn:schemas-microsoft-com:vml\" xmlns:w=\"urn:schemas-microsoft-com:office:word\" href=\"https://www.maratonafotograficabrescia.it/maratona-fotografica/brescia-speciale-tappa-istantanea-collaborazione-lomography/\" style=\"width: 270px;\" strokewidth=\"1px\" strokecolor=\"#7c9bd3\" fillcolor=\"#7c9bd3\">\r\n        <v:textbox style=\"mso-fit-shape-to-text:t\" inset=\"14px,7px,14px,7px\">\r\n          <center style=\"color: #ffffff; font-family: -apple-system, BlinkMacSystemFont, '.SFNSText-Regular', 'San Francisco', 'Roboto', 'Segoe UI', 'Helvetica Neue', 'Lucida Grande', sans-serif; font-size: 14px; line-height: 20px; font-weight: normal;\">LEGGI DI PI√ô</center>\r\n        </v:textbox>\r\n      </v:rect>\r\n      <![endif]-->\r\n      <a href=\"https://www.maratonafotograficabrescia.it/maratona-fotografica/brescia-speciale-tappa-istantanea-collaborazione-lomography/\" style=\"background-color: #7c9bd3; border: 1px solid #7c9bd3; border-radius: 14px; color: #ffffff; display: inline-block; font-family: -apple-system, BlinkMacSystemFont, '.SFNSText-Regular', 'San Francisco', 'Roboto', 'Segoe UI', 'Helvetica Neue', 'Lucida Grande', sans-serif; font-size: 14px; line-height: 20px; font-weight: normal; text-align: center; text-decoration: none; width: 320px; padding: 14px 0;\"><span style=\"display: inline-block; padding: 0 14px;\">LEGGI DI PI√ô</span></a>\r\n    </div>\r\n    </td>\r\n              </tr>\r\n            </table>\r\n          </td>\r\n        </tr>\r\n      </table>\r\n                          \r\n      <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"600\" bgcolor=\"#ffffff\" style=\"line-height: 0px; background-color: #ffffff;\">\r\n        <tr>\r\n          <td class=\"responsive\">\r\n            <img width=\"600\" height=\"60\" class=\"spacer\" alt=\" \" src=\"http://www.thelomographer.com/2017/nl_local_events_it/images/spacer.gif\" />\r\n          </td>\r\n        </tr>\r\n      </table>\r\n    \r\n      <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"600\" bgcolor=\"#383653\" style=\"line-height: 0px; background-color: #383653;\">\r\n        <tr>\r\n          <td class=\"responsive\">\r\n            <img width=\"600\" height=\"40\" class=\"spacer\" alt=\" \" src=\"http://www.thelomographer.com/2017/nl_local_events_it/images/spacer.gif\" />\r\n          </td>\r\n        </tr>\r\n      </table>\r\n    <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"600\" bgcolor=\"#ffffff\" background=\"http://www.thelomographer.com/2017/nl_redesign_events/images/space.gif\" style=\"line-height: 0px; background-color: #ffffff; background-image: url('http://www.thelomographer.com/2017/nl_redesign_events/images/space.gif'); background-repeat: repeat-y; background-size: 100% auto;\" class=\"\">\r\n  <tr>\r\n    <td class=\"responsive\">\r\n      <a href=\"https://microsites.lomography.com/25-years-of-lomography/get-involved/\">\r\n        <img width=\"600\" class=\"responsive\" alt=\"photo\" src=\"http://www.thelomographer.com/static/footer_25years.gif\" />\r\n      </a>\r\n    </td>\r\n  </tr>\r\n</table>\r\n\r\n      <table border=\"0\" cellpadding=\"0\" cellspacing=\"10\" width=\"600\" bgcolor=\"#383653\" style=\"background-color: #383653;\">\r\n        <tr>\r\n          <td class=\"responsive\" valign=\"top\" bgcolor=\"#383653\" style=\"background-color: #383653;\">\r\n            <table border=\"0\" cellpadding=\"10\" cellspacing=\"0\" width=\"580\">\r\n              <tr>\r\n                <td class=\"responsive\" valign=\"top\" align=\"left\"><font style=\"font-family: -apple-system, BlinkMacSystemFont, '.SFNSText-Regular', 'San Francisco', 'Roboto', 'Segoe UI', 'Helvetica Neue', 'Lucida Grande', sans-serif; font-size: 16px; line-height: 30px; color: #ffffff;\">\r\n<span style=\"font-family:sans-serif;\">\r\nVenticinque anni fa, il mondo della fotografia √® cambiato per sempre. Unisciti a noi nel festeggiare i 25 anni di Lomography! Da competizioni a mostre, feste e molto altro ancora, abbiamo un sacco di novit√† in programma. Visita il <a style=\"color: #ffffff; text-decoration: underline;\" href=\"https://microsites.lomography.com/25-years-of-lomography/get-involved/\">microsito dei 25 Anni di Lomography </a> e partecipa anche tu!\r\n</span>\r\n</font></td>\r\n              </tr>\r\n            </table>\r\n          </td>\r\n        </tr>\r\n      </table>\r\n    \r\n      <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"600\" bgcolor=\"#383653\" style=\"line-height: 0px; background-color: #383653;\">\r\n        <tr>\r\n          <td class=\"responsive\">\r\n            <img width=\"600\" height=\"40\" class=\"spacer\" alt=\" \" src=\"http://www.thelomographer.com/2017/nl_local_events_it/images/spacer.gif\" />\r\n          </td>\r\n        </tr>\r\n      </table>\r\n                                    \r\n      <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"600\" bgcolor=\"#ffffff\" style=\"line-height: 0px; background-color: #ffffff;\">\r\n        <tr>\r\n          <td class=\"responsive\">\r\n            <img width=\"600\" height=\"80\" class=\"spacer\" alt=\" \" src=\"http://www.thelomographer.com/2017/nl_local_events_it/images/spacer.gif\" />\r\n          </td>\r\n        </tr>\r\n      </table>\r\n    \r\n      <table border=\"0\" cellpadding=\"0\" cellspacing=\"10\" width=\"600\" bgcolor=\"#ffffff\" style=\"background-color: #ffffff;\">\r\n        <tr>\r\n          <td class=\"responsive\" valign=\"top\" bgcolor=\"#ffffff\" style=\"background-color: #ffffff;\">\r\n            <table border=\"0\" cellpadding=\"10\" cellspacing=\"0\" width=\"580\">\r\n              <tr>\r\n                <td class=\"responsive\" valign=\"top\" align=\"center\"><font style=\"font-family: -apple-system, BlinkMacSystemFont, '.SFNSText-Regular', 'San Francisco', 'Roboto', 'Segoe UI', 'Helvetica Neue', 'Lucida Grande', sans-serif; font-size: 13px; line-height: 26px; color: #4f5661;\"><a style=\"color: #4f5661; text-decoration: underline;\" href=\"%{unsubscribe_link}\">Gestisci le tue impostazioni di ricezione</a><br/><a style=\"color: #4f5661; text-decoration: underline;\" href=\"http://shop.lomography.com/it\">Dai un‚Äôocchiata ai nostri prodotti</a><br/><a style=\"color: #4f5661; text-decoration: underline;\" href=\"https://www.lomography.it/about/stores\">Visita uno dei nostri store</a><br/><a style=\"color: #4f5661; text-decoration: underline;\" href=\"https://www.lomography.it\">Unisciti alla community</a><br/><a style=\"color: #4f5661; text-decoration: underline;\" href=\"https://www.lomography.it/magazine\">Leggi il nostro magazine</a></font></td>\r\n              </tr>\r\n            </table>\r\n          </td>\r\n        </tr>\r\n      </table>\r\n    \r\n      <table border=\"0\" cellpadding=\"0\" cellspacing=\"10\" width=\"600\" bgcolor=\"#ffffff\" style=\"background-color: #ffffff;\">\r\n        <tr>\r\n          <td class=\"responsive\" valign=\"top\" bgcolor=\"#ffffff\" style=\"background-color: #ffffff;\">\r\n            <table border=\"0\" cellpadding=\"10\" cellspacing=\"0\" width=\"580\">\r\n              <tr>\r\n                <td class=\"responsive\" valign=\"top\" align=\"left\"><font style=\"font-family: -apple-system, BlinkMacSystemFont, '.SFNSText-Regular', 'San Francisco', 'Roboto', 'Segoe UI', 'Helvetica Neue', 'Lucida Grande', sans-serif; font-size: 13px; line-height: 26px; color: #4f5661;\"><strong>Lomography Italy</strong>: Kaiserstrasse 34/12, 1070 Vienna, Austria, <a style=\"color: #4f5661; text-decoration: underline;\" href=\"tel:+431899440\">+43-1-899-440</a><br/></font></td>\r\n              </tr>\r\n            </table>\r\n          </td>\r\n        </tr>\r\n      </table>\r\n    \r\n      <table border=\"0\" cellpadding=\"0\" cellspacing=\"10\" width=\"600\" bgcolor=\"#ffffff\" style=\"background-color: #ffffff;\">\r\n        <tr>\r\n          <td class=\"responsive\" valign=\"top\" bgcolor=\"#ffffff\" style=\"background-color: #ffffff;\">\r\n            <table border=\"0\" cellpadding=\"10\" cellspacing=\"0\" width=\"580\">\r\n              <tr>\r\n                <td class=\"responsive\" valign=\"top\" align=\"left\"><font style=\"font-family: -apple-system, BlinkMacSystemFont, '.SFNSText-Regular', 'San Francisco', 'Roboto', 'Segoe UI', 'Helvetica Neue', 'Lucida Grande', sans-serif; font-size: 13px; line-height: 26px; color: #4f5661;\">Nonostante il contenuto di questa newsletter sia stato creato con massima attenzione, non diamo garanzia delle correttezza e completezza delle informazioni date. La disponibilit√† dei prodotti pu√≤ variare a seconda della localit√†.</font></td>\r\n              </tr>\r\n            </table>\r\n          </td>\r\n        </tr>\r\n      </table>\r\n    \r\n      <table border=\"0\" cellpadding=\"0\" cellspacing=\"10\" width=\"600\" bgcolor=\"#ffffff\" style=\"background-color: #ffffff;\">\r\n        <tr>\r\n          <td class=\"responsive\" valign=\"top\" bgcolor=\"#ffffff\" style=\"background-color: #ffffff;\">\r\n            <table border=\"0\" cellpadding=\"10\" cellspacing=\"0\" width=\"580\">\r\n              <tr>\r\n                <td class=\"responsive\" valign=\"top\" align=\"center\"><font style=\"font-family: -apple-system, BlinkMacSystemFont, '.SFNSText-Regular', 'San Francisco', 'Roboto', 'Segoe UI', 'Helvetica Neue', 'Lucida Grande', sans-serif; font-size: 13px; line-height: 26px; color: #4f5661;\"><a style=\"color: #4f5661; text-decoration: underline;\" href=\"https://www.lomography.it\"><img width=\"192\" height=\"42\" alt=\"Lomography\" src=\"http://www.thelomographer.com/static/lomography.png\" /></a></font></td>\r\n              </tr>\r\n            </table>\r\n          </td>\r\n        </tr>\r\n      </table>\r\n    \r\n      <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"600\" bgcolor=\"#ffffff\" style=\"line-height: 0px; background-color: #ffffff;\">\r\n        <tr>\r\n          <td class=\"responsive\">\r\n            <img width=\"600\" height=\"40\" class=\"spacer\" alt=\" \" src=\"http://www.thelomographer.com/2017/nl_local_events_it/images/spacer.gif\" />\r\n          </td>\r\n        </tr>\r\n      </table>\r\n                      </td>\r\n      </tr>\r\n    </table>\r\n      </body>\r\n</html>\r\n"
      links = Text.new.check_links(text)

      assert links.values.all? { |e| e }
      assert_equal 30, links.count
    end

  end

  class Text
    include DarkLinks::LinkValidator
  end
end
